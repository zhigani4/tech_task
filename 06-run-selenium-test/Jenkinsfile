#!/usr/bin/env groovy

pipeline {
    agent any
    environment {
        COUNT =  "${params.COUNT_NODES}"
        DRIVER_HOST = "${params.DRIVER_HOST}"
    }
    stages {
       stage('Build and run selenium pytest') {
          steps{
              script {
                  currentBuild.displayName = "Build_Name_count_nodes_$COUNT ${env.BUILD_NUMBER}"
                  currentBuild.description = "Build run with $COUNT threads test to $DRIVER_HOST grid."
                  dir("${env.WORKSPACE}/06-run-selenium-test"){
                    sh "docker build -t selenium_tests ."
                    sh "docker run --label vers=${env.BUILD_NUMBER} -e DRIVER_HOST=${DRIVER_HOST} -i selenium_tests pytest -v -n ${COUNT} --html=reports/report.html || true" 
             }  
            }
          }
       }
        stage('Copy report from container') {
          steps{
              script {
                  dir("${env.WORKSPACE}/06-run-selenium-test"){
                    sh "CONTAINER_ID=\$(docker ps -a --filter 'label=vers=${env.BUILD_NUMBER}' -q)"
                    sh "docker cp '${CONTAINER_ID}:selenium/reports/report.html' ."  
             }  
            }
          }
       }
    }
}


